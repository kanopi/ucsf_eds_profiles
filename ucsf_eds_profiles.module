<?php

use Drupal\Core\Queue\QueueInterface;

/**
 * Implements hook_cron().
 *
 * Adds ucsf_eds and ucsf_profiles nodes to the queue system to be synchronized.
 */
function ucsf_eds_profiles_cron() {
  $config = \Drupal::config('ucsf_eds_profiles.settings');

  if ($config->get('ldap_enabled', TRUE)) {
    // How often to run in seconds, default one week.
    $delta = $config->get('cron_delta', 604800);

    // When was the cron last run. Uses Drupal state so that configuration is
    // not routinely clobbered every cron run.
    $last_run = \Drupal::state()->get('ucsf_eds_profiles.cron_last_run', 0);

    // If more than $delta seconds have past since nodes were updated, update them.
    if ($last_run + $delta < time()) {
      // Store the current runtime.
      $request_time = \Drupal::time()->getRequestTime();
      \Drupal::state()->set('ucsf_eds_profiles.cron_last_run', $request_time);

      // Logs cron run.
      \Drupal::logger('ucsf_eds_profiles')
        ->info('Adding all available EDS and Profiles nodes to the queue.');

      // Search for EDS/Profiles node data. This could still be improved.
      $nodes = \Drupal::entityTypeManager()
        ->getStorage('node')
        ->getQuery()
        ->condition('type', 'ucsf_eds_profiles')
        ->sort('nid')
        ->execute();

      if (!empty($nodes)) {
        $queue_factory = \Drupal::service('queue');
        /** @var QueueInterface $queue */
        $queue = $queue_factory->get('ucsf_eds_profiles_sync');
        foreach ($nodes as $nid => $vid) {
          $queue->createItem($nid);
        }
      }
    }
  }
}

/*
 * Implements hook_ucsf_eds_profiles_node_sync_pre_save().
 */
function ucsf_eds_profiles_ucsf_eds_profiles_node_sync_pre_save($values, $node, $eds, $eds_addr_campus, $eds_addr_practice, $eds_dept, $profile) {
  // Do nothing, but this must be done for invokeall to work.
  return $values;
}
